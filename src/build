#!/usr/bin/sh

BUILD_DATE=`date +%Y-%m-%d\ %H:%M`
GITTAG=`git tag | head`
GITCOMMIT=`git log -1 --pretty=oneline`
VERSIONFILE=huginn/version.go

echo Generating Version file
rm -f ${VERSIONFILE}
echo "package main" > ${VERSIONFILE}
echo "const (" >> ${VERSIONFILE}
echo "  VERSION = \"${GITTAG}\"" >> ${VERSIONFILE}
echo "  COMMIT = \"${GITCOMMIT}\"" >> ${VERSIONFILE}
echo "  FULL = \`" >> ${VERSIONFILE}
git log -1 --pretty=full >> ${VERSIONFILE}
echo "\`" >> ${VERSIONFILE}
echo "  BUILD_DATE = \"${BUILD_DATE}\"" >> ${VERSIONFILE}
echo ")" >> ${VERSIONFILE}


echo Build plugins
(cd huginn/raven; \
  for i in plugin-*/*.go ; do
    d=`dirname ${i}`
    p=`basename ${i} .go`
    go build -buildmode=plugin -o ../../../bin/plugins/${p}.so ${d}/${p}.go
  done 
)

echo Building huginn
(cd huginn; \
  go build -o ../../bin/huginn huginn.go version.go \
)

echo Build nmapparse
cp ${VERSIONFILE} nmapparse/
(cd nmapparse; \
  go build -o ../../bin/nmapparse nmapparse.go version.go \
)

exit 0
